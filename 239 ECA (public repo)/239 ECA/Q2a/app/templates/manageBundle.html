{% extends "base.html" %}

<body>
  {% block mainblock %}

  {% if bundles|length == 0 %}
    <h3>No Purchased Bundle</h3>
  {% else %}

  <!-- Single Blue Header Row for all bundles -->
  <div style="background-color: #2c5aa0; color: white; padding: 10px; display: table; width: 100%; table-layout: fixed;">
    <div style="display: table-cell; width: 15%; padding: 5px;">
      <strong>Purchase Date</strong>
    </div>
    <div style="display: table-cell; width: 15%; padding: 5px;">
      <strong>Expiry Date</strong>
    </div>
    <div style="display: table-cell; width: 15%; padding: 5px;">
      <!-- Empty column for images -->
    </div>
    <div style="display: table-cell; width: 55%; padding: 5px;">
      <strong>Packages In Bundle</strong>
    </div>
  </div>

  {% for bundle_data in bundles %}
    {% set bundle_index = loop.index %}

    <!-- Package Rows for each bundle -->
    {% for pkg_info in bundle_data.packages %}
    <div style="display: table; width: 100%; table-layout: fixed; padding: 15px 0;">

      {# --- Purchase Date column --- #}
      {% if loop.first and bundle_index > 1 %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: middle; border-top: 1px solid #e0e0e0;">
      {% else %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: middle;">
      {% endif %}
        {% if loop.first %}
          {{ bundle_data.purchased_date.strftime('%d/%m/%Y') }}
        {% endif %}
      </div>

      {# --- Expiry Date column --- #}
      {% if loop.first and bundle_index > 1 %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: middle; border-top: 1px solid #e0e0e0;">
      {% else %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: middle;">
      {% endif %}
        {% if loop.first %}
          {{ bundle_data.purchased_date.replace(year=bundle_data.purchased_date.year + 1).strftime('%d/%m/%Y') }}
        {% endif %}
      </div>

      {# --- Image column --- #}
      {% if loop.first and bundle_index > 1 %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: top; border-top: 1px solid #e0e0e0;">
      {% elif not loop.first %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: top; border-top: 1px solid #e0e0e0;">
      {% else %}
      <div style="display: table-cell; width: 15%; padding: 5px 10px; vertical-align: top;">
      {% endif %}
        <img src="{{ pkg_info.package.image_url }}" style="width: 150px; height: 150px; object-fit: cover;" />
      </div>

      {# --- Package details column --- #}
      {% if loop.first and bundle_index > 1 %}
      <div style="display: table-cell; width: 55%; padding: 5px 10px; vertical-align: top; border-top: 1px solid #e0e0e0;">
      {% elif not loop.first %}
      <div style="display: table-cell; width: 55%; padding: 5px 10px; vertical-align: top; border-top: 1px solid #e0e0e0;">
      {% else %}
      <div style="display: table-cell; width: 55%; padding: 5px 10px; vertical-align: top;">
      {% endif %}
        <div>
          <strong>{{ pkg_info.package.hotel_name }}</strong>
        </div>
        <div style="margin-top: 5px;">
          {% if pkg_info.is_expired %}
            <strong>Expired</strong>
          {% elif pkg_info.utilised %}
            <strong>Utilised:</strong> Yes
          {% else %}
            <strong>Utilised:</strong> Not yet
          {% endif %}
        </div>

        {% if not pkg_info.utilised and not pkg_info.is_expired %}
        <div style="margin-top: 10px;">
          <form method="POST" action="/bookFromBundle">
            <input type="hidden" value="{{ bundle_data.bundle_id }}" name="bundle_id">
            <input type="hidden" value="{{ pkg_info.package.id }}" name="package_id">
            <span><strong>Check-in Date</strong></span>
            <input type="date" name="check_in_date" required style="padding: 3px; margin-left: 5px; margin-right: 10px;">
            <button type="submit" class="btn btn-primary btn-sm">Book</button>
          </form>
        </div>
        {% endif %}
      </div>

    </div>
    {% endfor %}
  {% endfor %}
  {% endif %}

  {% endblock %}
</body>
