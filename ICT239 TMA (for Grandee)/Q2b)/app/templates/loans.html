{% extends "base.html" %}

{% block title %}Current Loans - SG Library{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background-color: #d4e9d4;
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .page-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
    }
    .loan-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 15px;
        display: grid;
        grid-template-columns: 80px 1fr 150px 150px 120px 100px;
        gap: 20px;
        align-items: center;
    }
    .loan-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 5px;
        display: grid;
        grid-template-columns: 80px 1fr 150px 150px 120px 100px;
        gap: 20px;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
        color: #333;
    }
    .header-title {
        grid-column: 1 / 3;
    }
    .header-due,
    .header-return,
    .header-renew,
    .header-actions {
        text-align: center;
    }
    .book-cover {
        width: 80px;
        height: 120px;
        object-fit: cover;
        border-radius: 3px;
        flex-shrink: 0;
    }
    .book-cover-placeholder {
        width: 80px;
        height: 120px;
        background-color: #e0e0e0;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .loan-details {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .book-title {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
        color: #333;
    }
    .book-authors {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
    }
    .loan-dates {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .date-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .date-label {
        font-size: 12px;
        color: #666;
        font-weight: bold;
        display: none;
    }
    .date-value {
        font-size: 14px;
        color: #333;
    }
    .date-value.overdue {
        color: #dc3545;
        font-weight: bold;
    }
    .loan-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
    }
    .btn-return {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        min-width: 80px;
    }
    .btn-return:hover {
        background-color: #218838;
    }
    .btn-renew {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        min-width: 80px;
    }
    .btn-renew:hover {
        background-color: #218838;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        min-width: 80px;
    }
    .btn-delete:hover {
        background-color: #c82333;
    }
    .no-loans {
        text-align: center;
        padding: 40px;
        background-color: white;
        border-radius: 5px;
        color: #666;
    }
    .logout-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 14px;
    }
    .logout-btn:hover {
        background-color: #5a6268;
        color: white;
    }
</style>
{% endblock %}

{% block page_title %}
CURRENT LOANS
{% endblock %}

{% block content %}
<!-- Table Headers -->
<div class="loan-header">
    <div class="header-title">Title/Author</div>
    <div class="header-due">Due Date</div>
    <div class="header-return">Return Date</div>
    <div class="header-renew">Renew Count</div>
    <div class="header-actions"></div>
</div>

<!-- Loans List -->
{% if loans %}
    {% for loan in loans %}
        <div class="loan-card">
            <!-- Book Cover -->
            {% if loan.book.url %}
                <img src="{{ loan.book.url }}" alt="{{ loan.book.title }}" class="book-cover">
            {% else %}
                <div class="book-cover-placeholder">
                    <span style="color: #999;">No Image</span>
                </div>
            {% endif %}

            <!-- Loan Details -->
            <div class="loan-details">
                <div class="book-title">{{ loan.book.title }}</div>
                <div class="book-authors">
                    By 
                    {% for author in loan.book.authors %}
                        {{ author.name }}{% if author.is_illustrator %} (Illustrator){% endif %}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Due Date -->
            <div class="date-info">
                <span class="date-value {% if loan.is_overdue %}overdue{% endif %}">
                    {{ loan.due_date.strftime('%d %b %Y') }}
                </span>
            </div>

            <!-- Return Date (if returned) -->
            <div class="date-info">
                {% if loan.returnDate %}
                    <span class="date-value">
                        {{ loan.returnDate.strftime('%d %b %Y') }}
                    </span>
                {% else %}
                    <span class="date-value">-</span>
                {% endif %}
            </div>

            <!-- Renew Count -->
            <div class="date-info">
                <span class="date-value">{{ loan.renewCount }}</span>
            </div>

            <!-- Action Buttons -->
            <div class="loan-actions">
                {% if loan.returnDate %}
                    <!-- Returned loan: only show Delete button -->
                    <form action="{{ url_for('view_loans') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this loan record?');">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="loan_id" value="{{ loan.id }}">
                        <button type="submit" class="btn-delete">Delete</button>
                    </form>
                {% elif loan.is_overdue or loan.renewCount >= 2 %}
                    <!-- Overdue or max renewals: only show Return button -->
                    <form action="{{ url_for('view_loans') }}" method="POST">
                        <input type="hidden" name="action" value="return">
                        <input type="hidden" name="loan_id" value="{{ loan.id }}">
                        <button type="submit" class="btn-return">Return</button>
                    </form>
                {% else %}
                    <!-- Active loan: show both Return and Renew buttons -->
                    <form action="{{ url_for('view_loans') }}" method="POST">
                        <input type="hidden" name="action" value="return">
                        <input type="hidden" name="loan_id" value="{{ loan.id }}">
                        <button type="submit" class="btn-return">Return</button>
                    </form>
                    <form action="{{ url_for('view_loans') }}" method="POST">
                        <input type="hidden" name="action" value="renew">
                        <input type="hidden" name="loan_id" value="{{ loan.id }}">
                        <button type="submit" class="btn-renew">Renew</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="no-loans">
        <h4>No loans found</h4>
        <p>You don't have any current loans.</p>
    </div>
{% endif %}

{% endblock %}